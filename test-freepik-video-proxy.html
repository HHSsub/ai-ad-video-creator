<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freepik ë™ì˜ìƒ ìƒì„± í…ŒìŠ¤íŠ¸ (í”„ë¡ì‹œ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-4xl">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Freepik ë™ì˜ìƒ ìƒì„± í…ŒìŠ¤íŠ¸ (í”„ë¡ì‹œ)</h1>
        
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 class="text-blue-800 font-semibold mb-2">ğŸ“Œ í”„ë¡ì‹œ ì„œë²„ ì‚¬ìš©</h3>
            <p class="text-blue-700 text-sm">ì´ í˜ì´ì§€ëŠ” CORS ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•´ Freepik APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.</p>
        </div>
        
        <!-- API í‚¤ ì…ë ¥ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">API ì„¤ì •</h2>
            <div class="mb-4">
                <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-2">Freepik API í‚¤</label>
                <input type="password" id="apiKey" placeholder="ì—¬ê¸°ì— Freepik API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="text-sm text-gray-500 mt-1">API í‚¤ëŠ” <a href="https://www.freepik.com/api" target="_blank" class="text-blue-500 hover:underline">Freepik API í˜ì´ì§€</a>ì—ì„œ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <!-- ë™ì˜ìƒ ìƒì„± í¼ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ë™ì˜ìƒ ìƒì„± (Image-to-Video)</h2>
            
            <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
            <div class="mb-4">
                <label for="imageInput" class="block text-sm font-medium text-gray-700 mb-2">ì²« í”„ë ˆì„ ì´ë¯¸ì§€</label>
                <input type="file" id="imageInput" accept="image/*" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="text-sm text-gray-500 mt-1">JPG, JPEG, PNG í˜•ì‹ë§Œ ì§€ì›. ìµœëŒ€ 20MB, ìµœì†Œ 300px</p>
                
                <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                <div id="imagePreview" class="mt-4 hidden">
                    <img id="previewImg" src="" alt="Preview" class="max-w-xs h-auto border rounded-lg">
                </div>
            </div>

            <!-- ë˜ëŠ” ì´ë¯¸ì§€ URL -->
            <div class="mb-4">
                <label for="imageUrl" class="block text-sm font-medium text-gray-700 mb-2">ë˜ëŠ” ì´ë¯¸ì§€ URL</label>
                <input type="url" id="imageUrl" placeholder="https://example.com/image.jpg" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="text-sm text-gray-500 mt-1">ì´ë¯¸ì§€ íŒŒì¼ ëŒ€ì‹  URLì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="videoPrompt" class="block text-sm font-medium text-gray-700 mb-2">ë™ì˜ìƒ í”„ë¡¬í”„íŠ¸</label>
                    <textarea id="videoPrompt" rows="3" placeholder="ë™ì˜ìƒì—ì„œ ì¼ì–´ë‚  ì›€ì§ì„ì„ ì„¤ëª…í•˜ì„¸ìš”" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">A beautiful sunset over the mountains with birds flying in the sky</textarea>
                    <p class="text-sm text-gray-500 mt-1">ìµœëŒ€ 2000ì</p>
                </div>
                <div>
                    <label for="duration" class="block text-sm font-medium text-gray-700 mb-2">ë™ì˜ìƒ ê¸¸ì´</label>
                    <select id="duration" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="6" selected>6ì´ˆ</option>
                        <option value="10">10ì´ˆ</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="promptOptimizer" checked 
                           class="mr-2 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="text-sm text-gray-700">í”„ë¡¬í”„íŠ¸ ìµœì í™” ì‚¬ìš©</span>
                </label>
                <p class="text-sm text-gray-500 mt-1">AIê°€ ìë™ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ë¥¼ ìµœì í™”í•˜ì—¬ ë” ë‚˜ì€ ê²°ê³¼ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
            </div>

            <button onclick="generateVideo()" 
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-200">
                ë™ì˜ìƒ ìƒì„±
            </button>
        </div>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loading" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-yellow-600 mr-3"></div>
                <span class="text-yellow-800">ë™ì˜ìƒì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
            </div>
            <div class="mt-2">
                <p class="text-sm text-yellow-700">Task ID: <span id="taskId" class="font-mono"></span></p>
                <p class="text-sm text-yellow-700">ì˜ˆìƒ ì†Œìš” ì‹œê°„: 2-5ë¶„</p>
            </div>
        </div>

        <!-- ê²°ê³¼ í‘œì‹œ -->
        <div id="result" class="hidden bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">ìƒì„± ê²°ê³¼</h2>
            <div id="videoContainer">
                <!-- ìƒì„±ëœ ë™ì˜ìƒì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ì—ëŸ¬ í‘œì‹œ -->
        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <h3 class="text-red-800 font-semibold mb-2">ì˜¤ë¥˜ ë°œìƒ</h3>
            <p id="errorMessage" class="text-red-700"></p>
        </div>

        <!-- ë¡œê·¸ -->
        <div class="bg-gray-50 rounded-lg p-4 mt-6">
            <h3 class="text-lg font-semibold mb-2">API ì‘ë‹µ ë¡œê·¸</h3>
            <pre id="log" class="text-sm text-gray-600 whitespace-pre-wrap max-h-96 overflow-y-auto"></pre>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let pollInterval = null;
        const PROXY_BASE_URL = 'http://localhost:3001'; // í”„ë¡ì‹œ ì„œë²„ ì£¼ì†Œ

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function showError(message) {
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
            log(`ERROR: ${message}`);
        }

        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        function showLoading(taskId) {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('taskId').textContent = taskId;
            document.getElementById('result').classList.add('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        // ì´ë¯¸ì§€ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function generateVideo() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const videoPrompt = document.getElementById('videoPrompt').value.trim();
            const duration = parseInt(document.getElementById('duration').value);
            const promptOptimizer = document.getElementById('promptOptimizer').checked;
            const imageFile = document.getElementById('imageInput').files[0];
            const imageUrl = document.getElementById('imageUrl').value.trim();

            if (!apiKey) {
                showError('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!videoPrompt) {
                showError('ë™ì˜ìƒ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!imageFile && !imageUrl) {
                showError('ì²« í”„ë ˆì„ ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (videoPrompt.length > 2000) {
                showError('í”„ë¡¬í”„íŠ¸ëŠ” 2000ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            hideError();

            let firstFrameImage;
            
            try {
                if (imageFile) {
                    // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜
                    firstFrameImage = await fileToBase64(imageFile);
                } else {
                    // URL ì‚¬ìš©
                    firstFrameImage = imageUrl;
                }

                const requestData = {
                    prompt: videoPrompt,
                    first_frame_image: firstFrameImage,
                    duration: duration,
                    prompt_optimizer: promptOptimizer,
                    webhook_url: null // ì›¹í›… ì—†ì´ í´ë§ìœ¼ë¡œ ìƒíƒœ í™•ì¸
                };

                log(`ë™ì˜ìƒ ìƒì„± ìš”ì²­ (í”„ë¡ì‹œ ê²½ìœ ): ${JSON.stringify({...requestData, first_frame_image: imageFile ? '[Base64 Image Data]' : firstFrameImage}, null, 2)}`);

                const response = await fetch(`${PROXY_BASE_URL}/api/freepik/video`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-freepik-api-key': apiKey
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                log(`í”„ë¡ì‹œ ì„œë²„ ì‘ë‹µ: ${JSON.stringify(data, null, 2)}`);

                if (!response.ok) {
                    throw new Error(data.message || data.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                if (data.data && data.data.task_id) {
                    currentTaskId = data.data.task_id;
                    showLoading(currentTaskId);
                    startPolling(apiKey, currentTaskId);
                } else {
                    throw new Error('Task IDë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }

            } catch (error) {
                showError(`ë™ì˜ìƒ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
                hideLoading();
            }
        }

        async function checkTaskStatus(apiKey, taskId) {
            try {
                const response = await fetch(`${PROXY_BASE_URL}/api/freepik/video/${taskId}`, {
                    headers: {
                        'x-freepik-api-key': apiKey
                    }
                });

                const data = await response.json();
                log(`ìƒíƒœ í™•ì¸ (í”„ë¡ì‹œ ê²½ìœ ): ${JSON.stringify(data, null, 2)}`);

                if (!response.ok) {
                    throw new Error(data.message || data.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                return data;
            } catch (error) {
                log(`ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${error.message}`);
                throw error;
            }
        }

        function startPolling(apiKey, taskId) {
            pollInterval = setInterval(async () => {
                try {
                    const statusData = await checkTaskStatus(apiKey, taskId);
                    
                    if (statusData.data.status === 'COMPLETED') {
                        clearInterval(pollInterval);
                        hideLoading();
                        displayVideoResult(statusData.data);
                    } else if (statusData.data.status === 'FAILED') {
                        clearInterval(pollInterval);
                        hideLoading();
                        showError('ë™ì˜ìƒ ìƒì„±ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    // IN_PROGRESSì¸ ê²½ìš° ê³„ì† í´ë§
                } catch (error) {
                    clearInterval(pollInterval);
                    hideLoading();
                    showError(`ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
                }
            }, 5000); // 5ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸ (ë™ì˜ìƒì€ ì‹œê°„ì´ ë” ì˜¤ë˜ ê±¸ë¦¼)
        }

        function displayVideoResult(data) {
            const resultDiv = document.getElementById('result');
            const videoContainer = document.getElementById('videoContainer');
            
            videoContainer.innerHTML = '';
            
            if (data.video_url) {
                const videoDiv = document.createElement('div');
                videoDiv.className = 'border rounded-lg overflow-hidden';
                videoDiv.innerHTML = `
                    <video controls class="w-full h-auto" preload="metadata">
                        <source src="${data.video_url}" type="video/mp4">
                        ë¸Œë¼ìš°ì €ê°€ ë™ì˜ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </video>
                    <div class="p-4">
                        <p class="text-sm text-gray-600 mb-2">ìƒì„±ëœ ë™ì˜ìƒ</p>
                        <div class="flex gap-2">
                            <a href="${data.video_url}" target="_blank" 
                               class="text-blue-500 hover:underline text-sm">ìƒˆ íƒ­ì—ì„œ ë³´ê¸°</a>
                            <a href="${data.video_url}" download 
                               class="text-green-500 hover:underline text-sm">ë‹¤ìš´ë¡œë“œ</a>
                        </div>
                    </div>
                `;
                videoContainer.appendChild(videoDiv);
                
                resultDiv.classList.remove('hidden');
                log(`ë™ì˜ìƒ ìƒì„± ì™„ë£Œ: ${data.video_url}`);
            } else {
                showError('ìƒì„±ëœ ë™ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            log('Freepik ë™ì˜ìƒ ìƒì„± í…ŒìŠ¤íŠ¸ í˜ì´ì§€ (í”„ë¡ì‹œ)ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
            log('í”„ë¡ì‹œ ì„œë²„ê°€ http://localhost:3001ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
            log('API í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì´ë¯¸ì§€ì™€ í”„ë¡¬í”„íŠ¸ë¥¼ ì„¤ì •í•œ í›„ "ë™ì˜ìƒ ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
            log('ë™ì˜ìƒ ìƒì„±ì€ 2-5ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        });
    </script>
</body>
</html>

