# S3 ë¯¸ë””ì–´ ì˜ì†í™” í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## âœ… ì™„ë£Œëœ ì‘ì—… (2025-12-25)

**ì‘ì—… I, K ì™„ë£Œ**: S3 ì—…ë¡œë” ìœ í‹¸ë¦¬í‹° + Freepik/ì˜ìƒ S3 ì—…ë¡œë“œ

**ìˆ˜ì •ëœ íŒŒì¼**:
1. `server/utils/s3-uploader.js` (ì‹ ê·œ)
2. `api/storyboard-render-image.js`
3. `api/storyboard-init.js`
4. `api/compile-videos.js`

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•

### ì‚¬ì „ ì¤€ë¹„

1. **EC2 ë°°í¬**:
   ```bash
   cd /home/ec2-user/projects/ai-ad-video-creator
   git pull
   pm2 restart api-server
   ```

2. **S3 ê¶Œí•œ í™•ì¸**:
   ```bash
   # EC2ì—ì„œ ì‹¤í–‰
   aws s3 ls s3://nexxii-media-storage/
   # ì¶œë ¥: projects/, temp/, nexad-recommendations/
   ```

---

### í…ŒìŠ¤íŠ¸ 1: Freepik ì´ë¯¸ì§€ S3 ì—…ë¡œë“œ

**ëª©ì **: ì´ë¯¸ì§€ ìƒì„± ì‹œ S3ì— ìë™ ì—…ë¡œë“œë˜ëŠ”ì§€ í™•ì¸

**ì ˆì°¨**:
1. ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ `https://upnexx.ai/nexxii/` ì ‘ì†
2. ë¡œê·¸ì¸ (ê³„ì •: `new_test`)
3. í”„ë¡œì íŠ¸ ìƒì„± â†’ Auto ëª¨ë“œ ì„ íƒ
4. ì •ë³´ ì…ë ¥ í›„ "ê´‘ê³  ì˜ìƒ ìƒì„± ì‹œì‘" í´ë¦­
5. Step2ì—ì„œ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ ëŒ€ê¸° (ì•½ 2-3ë¶„)

**í™•ì¸ ì‚¬í•­**:
```bash
# EC2 ì„œë²„ ë¡œê·¸ í™•ì¸
pm2 logs api-server --lines 100

# ì˜ˆìƒ ë¡œê·¸:
# [pollTaskStatus] ğŸš€ S3 ì—…ë¡œë“œ ì‹œì‘: project=project_xxx, concept=1, scene=1
# [S3] ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹œì‘: https://cdn-magnific.freepik.com/...
# [S3] âœ… ì—…ë¡œë“œ ì™„ë£Œ: https://upnexx.ai/nexxii-storage/projects/project_xxx/images/concept_1_scene_1.jpg
```

**S3 í™•ì¸**:
```bash
# EC2ì—ì„œ ì‹¤í–‰
aws s3 ls s3://nexxii-media-storage/projects/ --recursive | grep project_
# ì¶œë ¥ ì˜ˆì‹œ:
# projects/project_1735105234567/images/concept_1_scene_1.jpg
# projects/project_1735105234567/images/concept_1_scene_2.jpg
```

**ë¸Œë¼ìš°ì € í™•ì¸**:
- Step3ì—ì„œ ì´ë¯¸ì§€ URLì´ `https://upnexx.ai/nexxii-storage/projects/...` í˜•ì‹ì¸ì§€ í™•ì¸
- ê°œë°œì ë„êµ¬ (F12) â†’ Network íƒ­ â†’ ì´ë¯¸ì§€ ë¡œë“œ í™•ì¸

---

### í…ŒìŠ¤íŠ¸ 2: ìµœì¢… ì˜ìƒ S3 ì—…ë¡œë“œ

**ëª©ì **: ì˜ìƒ í•©ì„± ì™„ë£Œ ì‹œ S3ì— ìë™ ì—…ë¡œë“œë˜ëŠ”ì§€ í™•ì¸

**ì ˆì°¨**:
1. í…ŒìŠ¤íŠ¸ 1 ì™„ë£Œ í›„ Step3ì—ì„œ ì»¨ì…‰ ì„ íƒ
2. Step4ì—ì„œ "ëª¨ë“  ì”¬ í™•ì • â†’ ì˜ìƒ í•©ì„±" í´ë¦­
3. ì˜ìƒ í•©ì„± ì™„ë£Œ ëŒ€ê¸° (ì•½ 1-2ë¶„)

**í™•ì¸ ì‚¬í•­**:
```bash
# EC2 ì„œë²„ ë¡œê·¸ í™•ì¸
pm2 logs api-server --lines 50

# ì˜ˆìƒ ë¡œê·¸:
# [compile-videos] ğŸš€ S3 ì—…ë¡œë“œ ì‹œì‘: { projectId: 'project_xxx', conceptId: '1', filename: 'compiled_xxx' }
# [S3] ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì‹œì‘: /tmp/compile-xxx/compiled_xxx.mp4
# [S3] âœ… ë¹„ë””ì˜¤ ì—…ë¡œë“œ ì™„ë£Œ: https://upnexx.ai/nexxii-storage/projects/project_xxx/videos/compiled_xxx.mp4
```

**S3 í™•ì¸**:
```bash
aws s3 ls s3://nexxii-media-storage/projects/ --recursive | grep videos
# ì¶œë ¥ ì˜ˆì‹œ:
# projects/project_1735105234567/videos/compiled_1735105678901_abc123.mp4
```

**ë¸Œë¼ìš°ì € í™•ì¸**:
- Step4ì—ì„œ ìµœì¢… ì˜ìƒ URLì´ `https://upnexx.ai/nexxii-storage/projects/...` í˜•ì‹ì¸ì§€ í™•ì¸
- ì˜ìƒ ì¬ìƒ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸

---

### í…ŒìŠ¤íŠ¸ 3: Fallback ë™ì‘ í™•ì¸

**ëª©ì **: S3 ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ì €ì¥ìœ¼ë¡œ fallbackë˜ëŠ”ì§€ í™•ì¸

**ì ˆì°¨**:
1. EC2ì—ì„œ ì„ì‹œë¡œ S3 ê¶Œí•œ ì œê±°:
   ```bash
   # IAM Role ë¶„ë¦¬ (í…ŒìŠ¤íŠ¸ìš©)
   # AWS Consoleì—ì„œ EC2 ì¸ìŠ¤í„´ìŠ¤ â†’ Actions â†’ Security â†’ Modify IAM role â†’ None
   ```

2. í…ŒìŠ¤íŠ¸ 1 ì¬ì‹¤í–‰

**í™•ì¸ ì‚¬í•­**:
```bash
# ì˜ˆìƒ ë¡œê·¸:
# [pollTaskStatus] âš ï¸ S3 ì—…ë¡œë“œ ì‹¤íŒ¨, Freepik URL ì‚¬ìš©: AccessDenied
# [compile-videos] âŒ S3 ì—…ë¡œë“œ ì‹¤íŒ¨: AccessDenied
# [compile-videos] Fallback: ë¡œì»¬ ì €ì¥ ì™„ë£Œ: /home/ec2-user/projects/ai-ad-video-creator/public/videos/compiled/...
```

**ë³µêµ¬**:
```bash
# IAM Role ì¬ì—°ê²°
# AWS Consoleì—ì„œ EC2 ì¸ìŠ¤í„‰ìŠ¤ â†’ Actions â†’ Security â†’ Modify IAM role â†’ NexxiiEC2Role
sudo reboot
```

---

### í…ŒìŠ¤íŠ¸ 4: CloudFront CDN í™•ì¸

**ëª©ì **: S3 URLì´ CloudFrontë¥¼ í†µí•´ ì œê³µë˜ëŠ”ì§€ í™•ì¸

**ì ˆì°¨**:
1. ë¸Œë¼ìš°ì €ì—ì„œ ì´ë¯¸ì§€/ì˜ìƒ URL ë³µì‚¬
2. ìƒˆ íƒ­ì—ì„œ ì§ì ‘ ì ‘ì†

**í™•ì¸ ì‚¬í•­**:
- URL í˜•ì‹: `https://upnexx.ai/nexxii-storage/projects/...`
- ì‘ë‹µ í—¤ë” í™•ì¸ (ê°œë°œì ë„êµ¬ â†’ Network):
  ```
  x-cache: Hit from cloudfront (ë˜ëŠ” Miss from cloudfront)
  x-amz-cf-id: ...
  ```

---

### í…ŒìŠ¤íŠ¸ 5: í”„ë¡œì íŠ¸ ì¬ì§„ì… í…ŒìŠ¤íŠ¸

**ëª©ì **: í”„ë¡œì íŠ¸ ì €ì¥ í›„ ì¬ì§„ì… ì‹œ S3 URLì´ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸

**ì ˆì°¨**:
1. í…ŒìŠ¤íŠ¸ 1 ì™„ë£Œ í›„ ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨ (F5)
2. í”„ë¡œì íŠ¸ ëª©ë¡ì—ì„œ í•´ë‹¹ í”„ë¡œì íŠ¸ í´ë¦­
3. Step3ìœ¼ë¡œ ìë™ ì´ë™ í™•ì¸

**í™•ì¸ ì‚¬í•­**:
- ì´ë¯¸ì§€ê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ëŠ”ì§€ í™•ì¸
- ì´ë¯¸ì§€ URLì´ ì—¬ì „íˆ `https://upnexx.ai/nexxii-storage/...` í˜•ì‹ì¸ì§€ í™•ì¸
- Freepik token ë§Œë£Œ ì—ëŸ¬ê°€ ì—†ëŠ”ì§€ í™•ì¸

---

## ğŸ› ë¬¸ì œ í•´ê²°

### ë¬¸ì œ 1: S3 ì—…ë¡œë“œ ì‹¤íŒ¨ (AccessDenied)

**ì›ì¸**: IAM Role ê¶Œí•œ ë¶€ì¡±

**í•´ê²°**:
```bash
# EC2ì—ì„œ IAM Role í™•ì¸
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/

# ì¶œë ¥ì´ ë¹„ì–´ìˆìœ¼ë©´ IAM Role ë¯¸ì—°ê²°
# AWS Consoleì—ì„œ NexxiiEC2Role ì—°ê²° í›„ ì¬ë¶€íŒ…
```

### ë¬¸ì œ 2: ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì§€ ì•ŠìŒ

**ì›ì¸**: CloudFront ì„¤ì • ì˜¤ë¥˜

**í•´ê²°**:
```bash
# S3 ì§ì ‘ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
aws s3 cp s3://nexxii-media-storage/projects/project_xxx/images/concept_1_scene_1.jpg ./test.jpg

# ì„±ê³µí•˜ë©´ CloudFront ì„¤ì • í™•ì¸
# AWS Console â†’ CloudFront â†’ nexxii-media-oac â†’ Behaviors â†’ /nexxii-storage/*
```

### ë¬¸ì œ 3: projectIdê°€ 'unknown'ìœ¼ë¡œ ì €ì¥ë¨

**ì›ì¸**: í”„ë¡œì íŠ¸ ìƒì„± ì‹œ projectId ëˆ„ë½

**í•´ê²°**:
```bash
# ì„œë²„ ë¡œê·¸ í™•ì¸
pm2 logs api-server | grep projectId

# projects.json í™•ì¸
cat /home/ec2-user/projects/ai-ad-video-creator/config/projects.json | grep -A 5 "project_"
```

---

## ğŸ“Š ì„±ê³µ ê¸°ì¤€

âœ… **ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ ì¡°ê±´**:
1. ì´ë¯¸ì§€ URLì´ `https://upnexx.ai/nexxii-storage/projects/...` í˜•ì‹
2. ì˜ìƒ URLì´ `https://upnexx.ai/nexxii-storage/projects/...` í˜•ì‹
3. S3 ë²„í‚·ì— íŒŒì¼ì´ ì‹¤ì œë¡œ ì¡´ì¬
4. í”„ë¡œì íŠ¸ ì¬ì§„ì… ì‹œ ì´ë¯¸ì§€/ì˜ìƒ ì •ìƒ ë¡œë“œ
5. Freepik token ë§Œë£Œ ì—ëŸ¬ ì—†ìŒ

---

## ğŸ“ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] EC2 ë°°í¬ ì™„ë£Œ (`git pull` + `pm2 restart`)
- [ ] S3 ê¶Œí•œ í™•ì¸ (`aws s3 ls`)
- [ ] í…ŒìŠ¤íŠ¸ 1: Freepik ì´ë¯¸ì§€ S3 ì—…ë¡œë“œ
- [ ] í…ŒìŠ¤íŠ¸ 2: ìµœì¢… ì˜ìƒ S3 ì—…ë¡œë“œ
- [ ] í…ŒìŠ¤íŠ¸ 3: Fallback ë™ì‘ í™•ì¸
- [ ] í…ŒìŠ¤íŠ¸ 4: CloudFront CDN í™•ì¸
- [ ] í…ŒìŠ¤íŠ¸ 5: í”„ë¡œì íŠ¸ ì¬ì§„ì… í…ŒìŠ¤íŠ¸
- [ ] ì„œë²„ ë¡œê·¸ì—ì„œ S3 ì—…ë¡œë“œ ì„±ê³µ í™•ì¸
- [ ] S3 ë²„í‚·ì—ì„œ íŒŒì¼ ì¡´ì¬ í™•ì¸
- [ ] ë¸Œë¼ìš°ì €ì—ì„œ ì´ë¯¸ì§€/ì˜ìƒ ì •ìƒ ë¡œë“œ í™•ì¸
